<form>
<label id="id" for="peer"></label>
<input type="text" name="peer" id="peer"/>
<input type="button" id="connect" value="Click to connect"></button>
</form>

<script src='http://cdn.peerjs.com/0.3.9/peer.js'></script>
<script src='phaser.min.js'></script>
<script src='event.js'></script>
<script src='bench.js'></script>
<script src='connection.js'></script>
<script src='input.js'></script>
<script src='gamestate.js'></script>

<div id = 'gameview'></div>

<script>

var peer = new Peer({key: 'lwjd5qra8257b9'});
var label = document.querySelector("#id");
var button = document.querySelector("#connect");
var peerId = document.querySelector("#peer");

var sprite;
var manager = new GameStateManager();
var input = new Input();
var conn = new Connection();

var game = new Phaser.Game(800, 600, Phaser.AUTO, 'gameview', { preload: preload, create: create, update: update });

function preload() {
    game.load.image('stick', 'stick.png');
}

function create() {
}

function update() {
    input.update();
    manager.update();
}

(function() {
    this.Intro = function() {
        this.name = "intro";

        conn.ready.on(this, function(id) {
            label.innerText = id;
        });

        conn.connect.on(this, function(conn) {
            manager.set('main');
        });

        button.onclick = function(e) {
            e.preventDefault();
            conn.connectTo(peerId.value);
            return false;
        }
    }

    this.Intro.prototype = new GameState();
    var Intro = this.Intro.prototype;

}).apply(window);

(function() {
    this.Main = function() {
        this.name = "main";
        this.sprite = null;
    }

    this.Main.prototype = new GameState();
    var Main = this.Main.prototype;

    Main.enter = function() {
        game.stage.backgroundColor = '#736357';
        this.sprite = game.add.sprite(300, 300, 'stick');
    }

    Main.update = function() {
        if (input.click) {
            this.sprite.x = game.input.activePointer.position.x;
            this.sprite.y = game.input.activePointer.position.y;
            conn.send({
                x:this.sprite.x,
                y:this.sprite.y
            });
        }

        var buf = conn.recv();
        if (buf.length > 0) {
            var loc = buf[buf.length-1];

            this.sprite.x = loc.x;
            this.sprite.y = loc.y;
        }
    }
}).apply(window);

manager.add(new Main());
manager.add(new Intro());
manager.set('intro');
</script>
