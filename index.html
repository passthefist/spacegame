<form>
<label id="id" for="peer"></label>
<input type="text" name="peer" id="peer"/>
<input type="button" id="connect" value="Click to connect"></input>
</form>

<button id="fullscreen">Fullscreen</button>

<input type="checkbox" name="controls" value="controls" id="ctrl"> Toggle control style <br>

<script src='http://cdn.peerjs.com/0.3.9/peer.js'></script>
<script src='phaser.min.js'></script>
<script src='event.js'></script>
<script src='bench.js'></script>
<script src='connection.js'></script>
<script src='input.js'></script>
<script src='gamestate.js'></script>
<script src='ship.js'></script>

<div allowfullscreen="true" style="cursor:none;" oncontextmenu="return false" id='gameview'></div>

<script>
var peer = new Peer({key: 'lwjd5qra8257b9'});
var label = document.querySelector("#id");
var button = document.querySelector("#connect");
var peerId = document.querySelector("#peer");

var sprite;
var manager = new GameStateManager();
var input = new Input();
var conn = new Connection();

/*
var game = new Phaser.Game(800, 600, Phaser.AUTO, 'gameview', { preload: preload, create: create, update: update });

function preload() {
    game.load.image('stick', 'stick.png');
}

function create() {
    manager.set('main');
}

function update() {
    input.update();
    manager.update();
}

(function() {
    this.Intro = function() {
        this.name = "intro";

        conn.ready.on(this, function(id) {
            label.innerText = id;
        });

        conn.connect.on(this, function(conn) {
            var data ={};
            data.conn = conn;
            manager.set('main',data);
        });

        button.onclick = function(e) {
            e.preventDefault();
            conn.connectTo(peerId.value);
            return false;
        }
    }

    this.Intro.prototype = new GameState();
    var Intro = this.Intro.prototype;

}).apply(window);

*/

var GameState = function(game) {
};

// Load images and sounds
GameState.prototype.preload = function() {
    this.game.load.image('bullet', 'bullet.png');
    this.game.load.image('background', 'stars.jpg');
    this.game.load.image('cursor', 'cursortarget.png');
    this.game.load.spritesheet('enemy', 'enemy.png',48,48);
    this.game.load.spritesheet('ship', 'ship.png', 48, 48);
};

// Setup the example
GameState.prototype.create = function() {
    // Set stage background to something sky colored
    this.game.add.tileSprite(0, 0, 3377, 1899, 'background');
    this.game.world.setBounds(0, 0, 3377, 1899);
    this.game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;

    // Create a missile and add it to the game in the bottom center of the stage
    this.ship = new Ship(this.game, {
        x: 1000,
        y: 300,
        sprite:'ship'
    });
    this.enemy = new Ship(this.game, {
        x: 2100,
        y: 1300,
        sprite:'enemy'
    });
    this.game.camera.follow(this.ship);
    this.game.add.existing(
        this.ship
    );

    this.game.add.existing(
        this.enemy
    );

    this.cursor = game.add.sprite(700,450,'cursor');

    document.querySelector("#fullscreen").onclick = function() {
        document.querySelector("#gameview").webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
    }

    document.querySelector('#ctrl').onchange = (function (e) {
        this.ctrlToggle = e.target.checked;
    }).bind(this);
};

// The update() method is called every frame
GameState.prototype.update = function() {
    input.update();


    this.cursor.x = this.game.input.activePointer.worldX;
    this.cursor.y = this.game.input.activePointer.worldY;


    /*this.ship.targetVector(
        this.game.input.activePointer.position.x - this.game.world.x,
        this.game.input.activePointer.position.y - this.game.world.y
    );*/

    this.enemy.targetVector(
        this.ship.x,
        this.ship.y
    );

    this.enemy.throttle(true);

    var dist = Phaser.Point.distance(this.ship, this.enemy);
    
    if (dist < 400) {
        if (Math.random() > 0.95 ) {
            this.enemy.fire();
        }
    }

    if (dist < 300) {
        this.enemy.retro();
    }

    if (dist > 450 && this.enemy.speed < 100 || dist > 550) {
        this.enemy.boost();
    }

    if (input.down) {
        this.ship.fire(
            this.game.input.activePointer.position.x - this.game.world.x,
            this.game.input.activePointer.position.y - this.game.world.y
        );
    }

    if (game.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR)) {
        this.ship.boost();
    }

    if (!this.ctrlToggle ) {
        this.game.debug.text("Click to fire", 30, 50);
        this.game.debug.text("W to thrust", 30, 70);
        this.game.debug.text("A/D to turn", 30, 90);
        this.game.debug.text("S to brake/reverse", 30, 110);
        this.game.debug.text("Space to boost", 30, 130);

        if (game.input.keyboard.isDown(Phaser.Keyboard.W)) {
            this.ship.throttle(true);
        } else {
            this.ship.throttle(false);
        }

        if (game.input.keyboard.isDown(Phaser.Keyboard.A)) {
            this.ship.turnLeft();
        }

        if (game.input.keyboard.isDown(Phaser.Keyboard.S)) {
            this.ship.retro();
        }

        if (game.input.keyboard.isDown(Phaser.Keyboard.D)) {
            this.ship.turnRight();
        }
    } else {
        this.game.debug.text("Click to fire", 30, 50);
        this.game.debug.text("WASD to move", 30, 70);
        this.game.debug.text("Space to boost", 30, 90);
        this.game.debug.text("Shift to brake", 30, 130);

        this.ship.throttle(false);
        if (game.input.keyboard.isDown(Phaser.Keyboard.W)) {
            this.ship.headUp();
            this.ship.throttle(true);
        }

        if (game.input.keyboard.isDown(Phaser.Keyboard.A)) {
            this.ship.headLeft();
            this.ship.throttle(true);
        }

        if (game.input.keyboard.isDown(Phaser.Keyboard.S)) {
            this.ship.headDown();
            this.ship.throttle(true);
        }

        if (game.input.keyboard.isDown(Phaser.Keyboard.D)) {
            this.ship.headRight();
            this.ship.throttle(true);
        }

        if (game.input.keyboard.isDown(Phaser.Keyboard.SHIFT)) {
            this.ship.retro();
        }
    }
};

var game = new Phaser.Game(1440, 900, Phaser.AUTO, 'gameview');
game.state.add('game', GameState, true);

</script>
